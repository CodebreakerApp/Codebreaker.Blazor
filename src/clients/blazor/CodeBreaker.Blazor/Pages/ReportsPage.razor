@page "/reports"
@using CodeBreaker.Blazor.Components
@using CodeBreaker.Services
@using CodeBreaker.Shared.Models.Api
@using CodeBreaker.Shared.Models.Data
@using CodeBreaker.Shared.Models.Extensions
@inject IGameReportClient Client
@inject ILoggerFactory LoggerFactory

<h2>Reports</h2>

<MudGrid>
    <MudItem xs="12" md="9">
        <MudDatePicker Label="Select the date" @bind-Date="_date" />
    </MudItem>
    <MudItem xs="12" md="3">
        <MudButton Variant="Variant.Filled" FullWidth="true" Disabled=@_isLoadingGames @onclick="async () => await GetGames()">
            @if (_isLoadingGames)
            {
                <div class="button-slot-start">
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                </div>
            }
            Load games
        </MudButton>
    </MudItem>
</MudGrid>

@if (_games is not null)
{
    <div class="reports-table">
        <MudTable
            Loading="@_isLoadingGames"
            Items="@_games"
            Hover="true">
            <HeaderContent>
                <MudTh>Gamername</MudTh>
                <MudTh>Start</MudTh>
                <MudTh>End</MudTh>
                <MudTh>Number of moves</MudTh>
                <MudTh Style="width: 40px"></MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Gamername">@context.Username</MudTd>
                <MudTd DataLabel="Start">@context.Start</MudTd>
                <MudTd DataLabel="End">
                    @if (context.End is null)
                    {
                        <MudTooltip Text="User did not finish the game">
                            <MudIcon Icon="@Icons.Filled.Close" />
                        </MudTooltip>
                    }
                    else
                    {
                        @context.End
                    }
                </MudTd>
                <MudTd DataLabel="Number of moves">@context.Moves.Count()</MudTd>
                <MudTd DataLabel="Expand for details">
                    @if (_game?.GameId == context.GameId)
                    {
                        <MudIconButton Icon="@Icons.Outlined.KeyboardArrowDown" Size="Size.Small" @onclick="HideDetails" />
                    }
                    else
                    {
                        <MudIconButton Icon="@Icons.Outlined.KeyboardArrowRight" Size="Size.Small" @onclick="async () => await ShowDetails(context.GameId)" />
                    }
                </MudTd>
            </RowTemplate>
            <ChildRowContent>
		    @if (_game?.GameId == context.GameId)
            {
                <MudTr>
                    <td colspan="4">
                        <ReportDetails Game="@_game" />
                    </td>
                </MudTr>
            }
            </ChildRowContent>
        </MudTable>
    </div>
}


